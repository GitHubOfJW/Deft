<!DOCTYPE html>
<html>
  
  <head>
    <meta charset="UTF-8">
    <title>欢迎页面-X-admin2.0</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,user-scalable=yes, minimum-scale=0.4, initial-scale=0.8,target-densitydpi=low-dpi" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="stylesheet" href="/public/css/font.css">
    <link rel="stylesheet" href="/public/css/xadmin.css">
    <script type="text/javascript" src="/public/js/jquery-3.3.1.min.js"></script>
    <script type="text/javascript" src="/public/lib/layui/layui.js" charset="utf-8"></script>
    <script type="text/javascript" src="/public/js/xadmin.js"></script>
    <script type="text/javascript" src="/public/js/template-web.js"></script>
    <!-- 让IE8/9支持媒体查询，从而兼容栅格 -->
    <!--[if lt IE 9]>
      <script src="https://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
      <script src="https://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  
  <body>
    <div class="x-nav">
      <span class="layui-breadcrumb">
        <a href="/welcome">首页</a>
        <a href="javascript:;">角色管理</a>
        <a>
          <cite>角色列表</cite></a>
      </span>
      <a class="layui-btn layui-btn-small" style="line-height:1.6em;margin-top:3px;float:right" href="javascript:;" id="refresh" title="刷新">
        <i class="layui-icon" style="line-height:30px">ဂ</i></a>
    </div>
    <div class="x-body">
      <div class="layui-row">
        <form class="layui-form layui-col-md12 x-so">
          <input class="layui-input" placeholder="开始日" name="start" id="start">
          <input class="layui-input" placeholder="截止日" name="end" id="end">
          <input type="text" name="name"  placeholder="请输入角色名" autocomplete="off" class="layui-input">
          <button class="layui-btn"  lay-submit="" lay-filter="sreach"><i class="layui-icon">&#xe615;</i></button>
        </form>
      </div>
      <xblock>
        <button class="layui-btn layui-btn-danger" id="delAll"><i class="layui-icon"></i>批量删除</button>
        <button class="layui-btn" onclick="x_admin_show('添加角色','/role/add')"><i class="layui-icon"></i>添加</button>
        <span class="x-right" id="totalcount" style="line-height:40px"></span>
      </xblock>
      <table class="layui-table"  lay-filter="roleList" id="table">
       
      </table>
    </div>
<script type="text/html" id="toolbar">
  <div class="layui-btn-container">
    <a title="编辑"  lay-event="edit"  href="javascript:;">
      <i class="layui-icon">&#xe642;</i>
    </a>
    <a title="删除" lay-event="delete" href="javascript:;">
      <i class="layui-icon">&#xe640;</i>
    </a>
  </div>
</script>
<script>
  
  layui.use(['table','form','laydate'], function(){
    const form = layui.form;
    const laydate = layui.laydate;
    const table = layui.table;
    // const $ =  layui.jquery;
     
    //执行一个laydate实例
    laydate.render({
      elem: '#start', //指定元素
      type: 'datetime'
    });

    //执行一个laydate实例
    laydate.render({
      elem: '#end', //指定元素
      type: 'datetime'
    });

      //第一个实例
      const tableObj = table.render({
        elem: '#table'
        ,height: 'full-204'
        ,url: '/api/role/list' //数据接口
        ,page: true //开启分页
        ,limit: 10
        ,cols: [[ //表头
          {width:'8%',type:'checkbox',fixed:'left'}
          ,{field: 'id', title: 'ID', width:'8%', sort: true}
          ,{field: 'name', title: '角色名', width:'14%'}
          ,{title: '拥有权限规则', width: '15%',templet:function(d){
            const rules = [];
            for(let  relItem of d.authRoleRels){
              rules.push(relItem.auth.name);
            }
            return rules.join(',')
          }}
          ,{field: 'enable', title: '开启/停用',width:'10%',
          templet:function(d){
            return `<input type="checkbox" name="switch" lay-filter="switch" value='${d.id}' lay-text="开启|停用" ${d.enable ? 'checked=""' : ""} lay-skin="switch">`;
          }}
          ,{field: 'remark', title: '描述',width:'15%',templet: function(d){
            return d.remark || '未填写'
          }}
          ,{field: 'createdTime', title: '创建时间',width:'15%'}
          ,{title: '操作',width:'16%',toolbar:'#toolbar',fixed:'right'}
        ]]
        ,done:function(res, curr, count){
           
        }
      });

      //监听事件
      table.on('tool(roleList)', function(obj){
        switch(obj.event){
          case 'delete':
            member_del(obj.data.id,function(){
                obj.del()
            })
          break;
          case 'edit':
            x_admin_show('编辑',`/role/edit/${obj.data.id}`)
          break;
        };
      });

      form.on('switch(switch)',function(obj){
        member_stop(obj.elem.checked,obj.value,function(status,message){
            if(!status){
              layer.msg(message,{icon:5,time:1000});
            }
        })
      })

      //监听查询
      form.on('submit(sreach)', function(data){
        tableObj.reload({
          where:data.field
        })
        return false;
      });

    
    
      $('#delAll').on('click',function(){
        const checkStatus =  table.checkStatus('table')
        const ids = checkStatus.data.map(obj=>{
            return obj.id;
        })
        delAll(ids,function(){
            table.reload('table',{})
        })
      })

      $('#refresh').click(function(){
           tableObj.reload();
      })
      
  });
  
   /*用户-停用*/
   function member_stop(enable,id,callback){
        $.ajax({
          url:'/api/role/status/'+ id,
          method:"POST",
          data:{
            enable:enable
          },
          type:'json',
          success:function(data){
             if(callback)callback(data.status,data.message)
          },
          error(){
            if(callback)callback(false,'服务器开小差了')
          }
        })
  }

  /*用户-删除*/
  function member_del(id,callback){
      layer.confirm('确认要删除吗？',function(index){
        $.ajax({
          url:'/api/role/delete',
          data:{
            ids:id
          },
          method:'POST',
          type:'json',
          success:function(data){
            if(data.status){
              //发异步删除数据
              if(callback){
                callback()
              }
              layer.msg(data.message,{icon:1,time:1000});
            }else{
              layer.msg(data.message,{icon:5,time:1000});
            }
          },
          error:function(res){
            layer.msg('服务器开小差了',{type:5,shade:0.2});
          }
        })
      });
  }


  // 批量删除
  function delAll (ids,callback) {
      if(!ids || ids.length <=0){
        layer.msg('并未选择',{icon:5,time:1000});
        return;
      }
    layer.confirm('确认要删除吗？这个事情很严重，考虑一下下！',function(index){
        $.ajax({
          url:'/api/role/delete',
          data:{
            ids:ids.join(",")
          },
          method:'POST',
          type:'json',
          success:function(data){
            if(data.status){
              //发异步删除数据
              if(callback){
                callback()
              }
              layer.msg(data.message,{icon:1,time:1000});
            }else{
              layer.msg(data.message,{icon:5,time:1000});
            }
          },
          error:function(res){
            layer.msg('服务器开小差了',{type:5,shade:0.2});
          }
      });
    });
  }
</script>
    <script>var _hmt = _hmt || []; (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?b393d153aeb26b46e9431fabaf0f6190";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();</script>
  </body>

</html>